<html>
<head>
    <script type="text/JavaScript" src="{{ gvm.RR_DOC_ROOT }}js/jquery-2.1.1.min.js"></script>
    <script type="text/JavaScript" src="{{ gvm.RR_DOC_ROOT }}js/spin.js"></script>
	<script type="text/JavaScript" src="{{ gvm.RR_DOC_ROOT }}js/common-utils.js"></script>
	{% if gvm.isMobile %}
	<link rel="stylesheet" href="{{ gvm.RR_DOC_ROOT }}styles/callout-mobile.css" />
	{% else %}
	<link rel="stylesheet" href="{{ gvm.RR_DOC_ROOT }}styles/callout-main.css" />
	{% endif %}
</head>

{% if callout_details_vm.firehall_id is defined %}
    {% if callout_details_vm.firehall is defined and callout_details_vm.firehall is not null %}
        {% if callout_details_vm.callout_id != -1 and callout_details_vm.calloutkey_id is defined %}
    <body class="ci_body">
        {% block callout_header_title %}
        <span class="ci_header">Call Information:</span>
        {% endblock %}
        
            {% set callkey_validated = false %}
            {% set callout_pending = false %}
            
            {% for row in callout_details_vm.callout_details_list %}
            
                {% block callout_header %}
		        <div id="callContent{{ loop.index }}">
		          <span class="ci_header_time">Page Time: {{ row.calltime }}</span><br />
		          <span class="ci_header_type">Call Type: {{ row.callout_type_desc }}</span><br />
		          <span class="ci_header_address">Call Address: {{ row.address }}</span><br />
		          <span class="ci_header_units">Responding Units: {{ row.units }}</span><br />
		          <span class="ci_header_status">Call Status: {{ row.callout_status_desc }}</span><br />
		          <span class="ci_header_status" id="geo_tag">Your GEO Position: ?</span>
		        </div>
                {% endblock %}
            
                {% set callout_pending = 
                        row.callout_status_completed == false and 
                        row.callout_status_cancelled == false %}
                
                
		        {% block callout_refresh_display %}
                <span id='reload_timer_ui' class='ci_reload_timer'></span>
		        {% endblock %}
                
		        <div id="callResponseContent{{ loop.index }}">
		        
		        {% block callout_responding_header %}
		        <span class="ci_responders_header">Responders:
                {% endblock %}
            
                {% for row_responding in callout_details_vm.callout_details_responding_list %}
                
                    {% block callout_responding_details %}
                    {% if loop.index > 1 %}
                    , &nbsp;
                    {% endif %}
                    
                    {% if row_responding.latitude is defined and 
                       row_responding.latitude != 0.0 and
                       row_responding.longitude is defined and 
                       row_responding.longitude != 0.0 %}
                    
				        <a target="_blank" href="http://maps.google.com/maps?saddr={{ row_responding.responder_location }}&daddr={{ row_responding.firehall_location }} ({{ row_responding.firehall_location }})"
				           class="ci_responders_user_link">{{ row_responding.user_id }}</a>

                    {% else %}
                    {{ row_responding.user_id }}
                    {% endif %}                    
            
                    {% endblock %}
                    
                {% endfor %}

		        </span><br />
		        
		        {% block callout_show_responding_map %}
		        <a target="_blank" href="{{ gvm.RR_DOC_ROOT }}ct/fhid={{ callout_details_vm.firehall_id }}&cid={{ callout_details_vm.callout_id }}&ta=mr&ckid=${{ callout_details_vm.calloutkey_id }}"
		           class="ci_responders_map_link">Show Responders Map</a>
		        {% endblock %}
		        
		        </div>
            
                <script type="text/javascript">            
                var callout_geo_dest = '{{ row.callout_geo_dest }}';
                </script>
            
                {% if callout_details_vm.google_map_type == 'javascript' %}

		          {% block callout_js_inline_map %}

                  {% include ['@custom/google-map-js-api-custom.twig.html', 'google-map-js-api.twig.html'] with 
                     { 'CALLORIGIN' : row.callout_geo_dest, 
                       'DESTINATION' : row.callout_address_dest,
                       'FDLOCATION' : callout_details_vm.firehall.WEBSITE.FIREHALL_GEO_COORD_LATITUDE ~ 
                                      ',' ~ 
                                      callout_details_vm.firehall.WEBSITE.FIREHALL_GEO_COORD_LONGITUDE,
                       'WEB_ROOT' : callout_details_vm.firehall.WEBSITE.WEBSITE_ROOT_URL }
                  %}

                  <!--  
                  <iframe frameborder="1" style="border:1"  
                      src="{{ gvm.RR_DOC_ROOT }}controllers/callout-details-controller.php?enable_map_view=true&fhid={{ callout_details_vm.firehall_id|url_encode }}&map_callout_geo_dest={{ row.callout_geo_dest|url_encode }}&map_callout_address_dest={{ row.callout_address_dest|url_encode }}&map_fh_geo_lat={{ callout_details_vm.firehall.WEBSITE.FIREHALL_GEO_COORD_LATITUDE|url_encode }}&map_fh_geo_long={{ callout_details_vm.firehall.WEBSITE.FIREHALL_GEO_COORD_LONGITUDE|url_encode }}&map_webroot={{ callout_details_vm.firehall.WEBSITE.WEBSITE_ROOT_URL|url_encode }}">
                  </iframe>
                  -->
		          
		          {% endblock %}
		        
		        {% else %}
                <div class="google-maps">
                  {% block callout_inline_map %} 
                  <iframe frameborder="1" style="border:1"  
                      src="https://www.google.com/maps/embed/v1/directions?key={{ callout_details_vm.firehall.WEBSITE.WEBSITE_GOOGLE_MAP_API_KEY }}&mode=driving&zoom=11&origin={{ callout_details_vm.firehall.WEBSITE.FIREHALL_HOME_ADDRESS }}&destination={{ row.callout_address_dest }}">
                  </iframe>
                  {% endblock %}
                </div>
		        
		        {% endif %}
                
                {% if callout_details_vm.calloutkey_id is defined and 
                      callout_details_vm.calloutkey_id != null and 
                      callout_details_vm.calloutkey_id == row.call_key %}
                    {% set callkey_validated = true %}
                {% endif %}
            {% endfor %}

            {% if callout_details_vm.callout_details_list is empty %}

                {% block callout_no_results %}            
                <span class="ci_header">No results unexpected!</span>
                {% endblock %}
                
            {% else %}
            
                {% if callout_details_vm.calloutkey_id is defined and 
                      callout_details_vm.calloutkey_id != null and 
                      callkey_validated == true %}

			        <br />
			        <table>

                    {% set no_response_count = 0 %}
                    {% for row_no in callout_details_vm.callout_details_not_responding_list %}

                        {% if callout_details_vm.member_id is null or
                           callout_details_vm.member_id == row_no.user_id %}
                
                            {% block callout_no_response %}
                            {% if callout_details_vm.ALLOW_CALLOUT_UPDATES_AFTER_FINISHED or callout_pending %}
                            <tr>
                            <td class="ci_align_cell">
                                <span class='inset-button'>{{ row_no.user_id }}</span>
                            </td>
                            <td class="ci_align_cell" colspan="2">
                                <INPUT TYPE="button" VALUE="Respond" 
                                       class="ci_respondnow" 
                                       onclick="if(confirmAppendGeoCoordinates('Confirm that {{ row_no.user_id }} is responding?',document.getElementById('call_no_response_{{ row_no.id }}'))) document.getElementById('call_no_response_{{ row_no.id }}').submit();"/>

                                <form id="call_no_response_{{ row_no.id }}" 
                                  action="{{ gvm.RR_DOC_ROOT }}cr/fhid={{ callout_details_vm.firehall_id }}&cid={{ callout_details_vm.callout_id }}&uid={{ row_no.user_id }}&ckid={{ callout_details_vm.calloutkey_id }}{% if callout_details_vm.member_id is not null %}&member_id={{ callout_details_vm.member_id }}{% endif %}" 
                                  method="POST" 
                                  onsubmit="return confirmAppendGeoCoordinates('Confirm that {{ row_no.user_id }} is responding?',document.getElementById('call_no_response_{{ row_no.id }}'));">
                                </form>
                            </td>
                            </tr>
                            {% endif %}
                            {% endblock %}
                            
                            {% set no_response_count = no_response_count + 1 %}
                        {% endif %}
                    {% endfor %}
                    
                    {% if callout_pending %}
                    
                        {% for row_yes in callout_details_vm.callout_details_end_responding_list %}
                    
	                        {% if callout_details_vm.member_id is null or
	                           callout_details_vm.member_id == row_yes.user_id %}
                    
                                {% block callout_yes_response_complete %}
	                            <tr>
	                            <td class="ci_align_cell">
                                    <span class='inset-button'>{{ row_yes.user_id }}</span>
                                </td>
                                <td class="ci_align_cell">
                                    <INPUT TYPE="button" VALUE="Complete the call" 
                                       class="ci_completenow" 
                                       onclick="if(confirmAppendGeoCoordinates('COMPLETE this call?\nConfirm that the call should be set to COMPLETE?',document.getElementById('call_yes_response_complete_{{ row_yes.id }}'))) document.getElementById('call_yes_response_complete_{{ row_yes.id }}').submit();" />
                                
                                    <form id="call_yes_response_complete_{{ row_yes.id }}" 
                                      action="{{ gvm.RR_DOC_ROOT }}cr/fhid={{ callout_details_vm.firehall_id }}&cid={{ callout_details_vm.callout_id }}&uid={{ row_yes.user_id }}&ckid={{ callout_details_vm.calloutkey_id }}{% if callout_details_vm.member_id is not null %}&member_id={{ callout_details_vm.member_id }}{% endif %}&status={{ callout_details_vm.callout_status_complete }}" 
                                      method="POST" 
                                      onsubmit="return confirmAppendGeoCoordinates('COMPLETE this call?\nConfirm that the call should be set to COMPLETE?',document.getElementById('call_yes_response_complete_{{ row_yes.id }}'));">
                                    </form>
                                </td>
                                {% endblock %}

                                {% block callout_yes_response_cancel %}
                                <td>
                                    <INPUT TYPE="button" VALUE="Cancel the call" 
                                       class="ci_cancelnow" 
                                       onclick="if(confirmAppendGeoCoordinates('CANCEL this call?\nConfirm that the call should be CANCELLED?',document.getElementById('call_yes_response_cancel_{{ row_yes.id }}'))) document.getElementById('call_yes_response_cancel_{{ row_yes.id }}').submit();" />
                                
                                    <form id="call_yes_response_cancel_{{ row_yes.id }}" 
                                  action="{{ gvm.RR_DOC_ROOT }}cr/fhid={{ callout_details_vm.firehall_id }}&cid={{ callout_details_vm.callout_id }}&uid={{ row_yes.user_id }}&ckid={{ callout_details_vm.calloutkey_id }}{% if callout_details_vm.member_id is not null %}&member_id={{ callout_details_vm.member_id }}{% endif %}&status={{ callout_details_vm.callout_status_cancel }}" 
                                  method="POST" 
                                  onsubmit="return confirmAppendGeoCoordinates('CANCEL this call?\nConfirm that the call should be CANCELLED?',document.getElementById('call_yes_response_cancel_{{ row_yes.id }}'));">
                                    </form>
                                </td>
                                </tr>
                                {% endblock %}
                                
                            {% endif %}
                        {% endfor %}
                        
                        </table>
                    
                    {% endif %}
                {% endif %}
            {% endif %}
             
        {% else %}
    <body class="ci_body_error">
    <h2><b>Invalid Request</b></h2>
           
        {% endif %}
    {% else %}
    <body class="ci_body_error">
    <h2><b>Invalid Request</b></h2>
    
        <div id="error">
            <h2>
            <b><font color="white">ERROR loading page, identifier not found!</font></b>
            </h2>
        </div>
    {% endif %}
{% else %}
    <body class="ci_body_error">
    <h2><b>Invalid Request</b></h2>

    <div id="error">
        <h2>
        <b><font color="white">ERROR loading page, invalid identifier!</font></b>
        </h2>
    </div>
{% endif %}

<script type="text/javascript">

function getGEOLocationCoords_callback_fn(geoAccess,param2) {
	//alert('In getGEOLocationCoords_callback_fn' + geoAccess);
	//alert(param2);
	console.info('In getGEOLocationCoords_callback_fn: access = ' + geoAccess);
	if(geoAccess && typeof callout_geo_dest != 'undefined') {
        //var geo_tag = document.getElementById('geo_tag');
        //if(typeof geo_tag != 'undefined') {
        	//geo_tag.textContent = 'Your GEO Position: ' + param2.lat + ", " + param2.lng;
        	$( '#geo_tag' ).html( 'Your GEO Position: ' + param2.lat + ", " + param2.lng );
        	//$( '#geo_tag' ).html( 'Your GEO Position: ' + param2.lat + ", " + param2.lng + " dest: " + callout_geo_dest);
        	console.info('You: ' + param2.lat + ", " + param2.lng + " dest: " + callout_geo_dest);
        	
        	var origin = new google.maps.LatLng( param2.lat, param2.lng );
        	var destination = callout_geo_dest; // using string

        	var directionsService = new google.maps.DirectionsService();
        	var request = {
        	    origin: origin, // LatLng|string
        	    destination: destination, // LatLng|string
        	    travelMode: google.maps.DirectionsTravelMode.DRIVING
        	};

        	directionsService.route( request, function( response, status ) {
        	    if ( status === 'OK' ) {
        	        var point = response.routes[ 0 ].legs[ 0 ];
        	        $( '#geo_tag' ).html( 'Estimated time to scene: ' + point.duration.text + ' (' + point.distance.text + ')' );
        	        console.info('Estimated time to scene: ' + point.duration.text + ' (' + point.distance.text + ')');
        	    }
        	} );        	
        //}
	}
}

function getGEOLocationCoords_initialize() {
	getGEOLocationCoords(getGEOLocationCoords_callback_fn);
}
// https://maps.googleapis.com/maps/api/js?v=3.exp&key={{ callout_details_vm.firehall.WEBSITE.WEBSITE_GOOGLE_MAP_API_KEY }}&alternatives=true&callback=map_initialize    
    
$( document ).ready(function() {
	
	//getGEOLocationCoords(getGEOLocationCoords_callback_fn);
        
	// Handle any responder tracking
	{% if callout_details_vm.firehall is defined and
	      callout_details_vm.firehall is not null and
	      callout_details_vm.callout_responding_user_id is defined and
	      callout_details_vm.callout_responding_user_id is not null and
	      callout_details_vm.firehall.MOBILE.MOBILE_TRACKING_ENABLED %}

	    var uri = window.location.toString();
	    if (uri.indexOf("?") > 0) {
	      var clean_uri = uri.substring(0, uri.indexOf("&cruid"));
	      window.history.replaceState({}, document.title, clean_uri);
	    }
	
        {% if gvm.enabled_asynch_mode %}
        openAjaxUrl("{{ gvm.RR_DOC_ROOT }}ct/fhid={{ callout_details_vm.firehall_id }}&cid={{ callout_details_vm.callout_id }}&delay=60&uid={{ callout_details_vm.callout_responding_user_id }}&ckid={{ callout_details_vm.calloutkey_id }}",true,10,30000);
        {% else %}
        openURLHidden("{{ gvm.RR_DOC_ROOT }}ct/fhid={{ callout_details_vm.firehall_id }}&cid={{ callout_details_vm.callout_id }}&delay=60&uid={{ callout_details_vm.callout_responding_user_id }}&ckid={{ callout_details_vm.calloutkey_id }}");
        {% endif %}
	
    {% endif %}

    {% if callout_pending is defined and callout_pending %}
        // Handle refresh of the page
        {% block callout_refresh_script %}
        
        var MAP_AUTO_REFRESH_SECONDS = 60;
        // This reloads the page
        setTimeout(function () { 
               location.reload(true); 
            }, MAP_AUTO_REFRESH_SECONDS * 1000);
        // This counts down to 0
        setInterval(function () { 
            var ui_refresh = document.getElementById('reload_timer_ui');
            if(typeof ui_refresh != 'undefined') {
                MAP_AUTO_REFRESH_SECONDS--;
                ui_refresh.textContent = MAP_AUTO_REFRESH_SECONDS + ' seconds until auto refresh';
            }
         }, 1000);
        
        {% endblock %}
    {% endif %}
    
});     
</script>

</body>
</html>